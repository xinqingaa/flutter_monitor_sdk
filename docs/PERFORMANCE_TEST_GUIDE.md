# 性能监控测试指南

## 📊 监控数据字段详解

### 核心卡顿数据
| 字段 | 含义 | 示例值 | 说明 |
|------|------|--------|------|
| `jank_count` | 连续卡顿帧数 | 11 | 连续11帧都超过阈值 |
| `max_duration_ms` | 最严重一帧耗时 | 60.747 | 最卡的一帧用了60.7ms |
| `average_duration_ms` | 平均每帧耗时 | 55.06 | 平均每帧55ms |
| `frame_budget_ms` | 帧预算时间 | 11.11 | 90fps设备每帧预算11.11ms |
| `jank_threshold_ms` | 卡顿阈值 | 22.22 | 超过22.22ms算卡顿 |

### 设备性能分析
| 字段 | 含义 | 示例值 | 说明 |
|------|------|--------|------|
| `average_frame_time_ms` | 平均帧时间 | 34.09 | 设备平均每帧34ms |
| `frame_time_variance` | 帧时间方差 | 548.31 | 波动很大，性能不稳定 |
| `fps` | 实际帧率 | 29.34 | 实际只有29fps |
| `stability` | 稳定性指标 | 0.313 | 31.3%稳定性(0-1) |
| `device_level` | 设备性能等级 | "low" | 低端设备 |

### 帧时间分布 (百分位数)
| 字段 | 含义 | 示例值 | 说明 |
|------|------|--------|------|
| `p50` | 50%分位数 | 52.45 | 50%的帧在52ms内 |
| `p90` | 90%分位数 | 56.58 | 90%的帧在56ms内 |
| `p95` | 95%分位数 | 59.35 | 95%的帧在59ms内 |
| `p99` | 99%分位数 | 60.75 | 99%的帧在60ms内 |

## 🎯 测试按钮效果说明

### 基础性能测试

#### 1. 轻微卡顿测试 (22ms)
- **触发方式**: 单次22ms耗时操作
- **预期结果**: 被抖动容忍机制忽略，**不输出日志**
- **原因**: 22ms < 阈值(22.22ms) + 抖动容忍(12ms) = 34.22ms

#### 2. 中等卡顿测试 (32ms)
- **触发方式**: 单次32ms耗时操作
- **预期结果**: 可能被检测到，**输出少量日志**
- **原因**: 32ms > 阈值(22.22ms)，但接近边界

#### 3. 严重卡顿测试 (55ms)
- **触发方式**: 单次55ms耗时操作
- **预期结果**: 肯定被检测到，**输出详细日志**
- **原因**: 55ms >> 阈值(22.22ms)，明显卡顿

### 连续卡顿测试

#### 4. 连续轻微卡顿 (3次22ms)
- **触发方式**: 连续3次22ms耗时操作
- **预期结果**: 可能被检测到，**输出少量日志**
- **原因**: 连续操作可能累积超过阈值

#### 5. 连续严重卡顿 (5次55ms)
- **触发方式**: 连续5次55ms耗时操作
- **预期结果**: 肯定被检测到，**输出详细日志**
- **原因**: 连续严重卡顿，肯定触发监控

### 性能压力测试

#### 6. 高频操作测试
- **触发方式**: 100次快速操作
- **预期结果**: 测试采样机制，**可能输出日志**
- **原因**: 高频操作测试采样控制

#### 7. 内存压力测试
- **触发方式**: 创建大量内存对象
- **预期结果**: 可能触发GC，**输出日志**
- **原因**: 内存压力可能导致卡顿

## 📝 时间戳格式优化

### 优化前
```json
"timestamp": "2025-10-25T06:06:17.592556Z"
```

### 优化后
```json
"timestamp": "2025-10-25 14:06:17"
```

## 🔍 如何判断监控是否正常工作

### 1. 查看控制台输出
- 寻找 `[Flutter Monitor Event]` 标记
- 检查是否有 `jank_sequence` 类型事件

### 2. 分析数据合理性
- `jank_count` > 3: 连续卡顿被检测到
- `max_duration_ms` > `jank_threshold_ms`: 确实有卡顿
- `fps` < 60: 设备性能不足
- `stability` < 0.5: 性能不稳定

### 3. 对比不同测试
- 轻微卡顿: 应该很少或没有日志
- 严重卡顿: 应该有详细日志
- 连续卡顿: 应该有更多日志

## 🚨 常见问题排查

### 问题1: 没有输出任何日志
**可能原因**:
- 卡顿程度不够严重
- 抖动容忍机制生效
- 采样机制跳过了检测

**解决方案**:
- 尝试"严重卡顿测试"按钮
- 检查设备性能配置

### 问题2: 日志过于频繁
**可能原因**:
- 设备性能较差
- 配置过于严格
- 应用本身有性能问题

**解决方案**:
- 使用宽松配置: `JankConfig.lenient()`
- 调整防抖时间

### 问题3: 时间戳格式不对
**解决方案**:
- 已修复，现在使用 `YYYY-MM-DD HH:MM:ss` 格式
- 使用本地时间而非UTC时间

## 📈 性能优化建议

### 1. 根据设备性能调整配置
```dart
// 低端设备
jankConfig: JankConfig.lenient()

// 高端设备  
jankConfig: JankConfig.strict()
```

### 2. 监控关键指标
- **FPS**: 应保持在50+以上
- **稳定性**: 应保持在0.7以上
- **P95帧时间**: 应小于33ms

### 3. 分析卡顿原因
- 查看 `max_duration_ms` 找出最卡的一帧
- 分析 `percentiles` 了解帧时间分布
- 关注 `device_level` 了解设备性能
